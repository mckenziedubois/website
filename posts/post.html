<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title id="page-title">Loading… | McKenzie DuBois</title>
  <link href="../css/styles.css" rel="stylesheet" />
  <link href="../css/custom.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css" />

</head>

<script src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script>
<script async src="https://www.airbnb.com/embeddable/airbnb_jssdk"></script>

<body>

  <!-- Navbar -->
  <div id="navbar-placeholder"></div>

  <!-- Masthead -->
  <header class="masthead" style="background-image: url('https://res.cloudinary.com/dsxlralvu/image/upload/v1761168364/header.jpg')">
    <div class="container position-relative px-4 px-lg-5">
      <div class="row gx-4 gx-lg-5 justify-content-center">
        <div class="col-md-10 col-lg-8 col-xl-7">
          <div class="post-heading text-center text-white">
            <h1 id="post-title">Loading…</h1>
            <h2 class="subheading" id="post-subtitle"></h2>
            <span class="meta" id="post-date"></span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="container px-4 px-lg-5 my-5">

    <div class="post-layout">
      <div class="post-left">
        <div id="markdown-content"></div>
      </div>

      <div class="post-right">
        <div class="return-button-container">
        <a href="../pages/bloghome.html" class="return-button">← Back to Guides</a>
        </div>
        <div class="mySwiper swiper">
          <div class="swiper-wrapper" id="gallery-wrapper"></div>
          <div class="swiper-pagination"></div>
        </div>
        <div id="airbnb-section"></div>
      </div>
    </div>

    <!-- MAP -->
    <div id="post-map"></div>

    <!-- Related posts -->
    <div class="container px-4 px-lg-5 my-5">
      <section class="related-posts mt-5">
        <div class="row gx-4 gx-lg-5" id="related-posts"></div>
      </section>
    </div>
    
  </main>

  <!-- Footer -->
  <div id="footer-placeholder"></div> 

  <!-- Common Scripts -->
  <div id="scripts-placeholder"></div>

  <!-- Load partials -->
  <script src="../js/load-partials.js"></script>
  <script>
    initPage({
      pageTitle: document.getElementById('post-title').textContent || 'Post',
      rootPrefix: '../',
      currentPage: 'post.html',
      loadMasthead: false 
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Post data fetch -->  
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const currentSlug = urlParams.get('slug');

    async function loadCSV(url) {
      const text = await fetch(url).then(r => r.text());
      const [headerLine, ...lines] = text.trim().split("\n");
      const headers = headerLine.split(",");

      return lines.map(line => {
        const cols = line.split(",");
        return Object.fromEntries(headers.map((h, i) => [h.trim(), cols[i]?.trim()]));
      });
    }

    async function initPost() {
        const posts = await 
        fetch('../posts/posts.json').
        then(res => res.json());

        const publishedPosts = posts.filter(p => p.active);
        const post = publishedPosts.find(p => p.slug === currentSlug);
        if (!post) return;

        // Set post header info
        document.getElementById('post-title').textContent = post.title;
        document.getElementById('post-subtitle').textContent = post.subtitle;
        document.getElementById('post-date').textContent = new Date(post.date)
        .toLocaleDateString('en-US', { month:'long', day:'numeric', year:'numeric' });
        document.getElementById('page-title').textContent = `${post.title} | McKenzie DuBois`;

      const mdRaw = await fetch(`../posts/content/${post.slug}.md`)
        .then(res => res.text());
      
      let html = marked.parse(mdRaw);
      document.getElementById('markdown-content').innerHTML = html;

      if (post.airbnbs && post.airbnbs.length > 0) {
        const airbnb_container = document.getElementById('airbnb-section');
        post.airbnbs.forEach(listing => {
          const embedHTML = `
            <div class="airbnb-embed-frame" 
                data-id="${listing.id}" 
                data-view="home"
                data-hide-price="true"
                style="width:450px; height:300px; margin:auto;">
              
            <a href="https://www.airbnb.com/rooms/${listing.id}?source=embed_widget">
              View On Airbnb
            </a>

            <a href="https://www.airbnb.com/rooms/${listing.id}?source=embed_widget" rel="nofollow">
              ${listing.text || ""}
            </a>

            </div>
          `;

        const wrapper = document.createElement("div");
        wrapper.innerHTML = embedHTML;
        airbnb_container.appendChild(wrapper);

        // VERY IMPORTANT — reinitialize the Airbnb widget
        if (window.AirbnbEmbedWidget) {
          window.AirbnbEmbedWidget.init();
        }
      });
    }

      // LOAD GALLERY IMAGES
      const metadata = await loadCSV('../pages/image_metadata.csv');
      const galleryImages = metadata.filter(img => img.slug === currentSlug);

      // Build Swiper slides
      const wrapper = document.getElementById('gallery-wrapper');
      galleryImages.forEach(img => {
        wrapper.innerHTML += `
          <div class="swiper-slide">
            <img src="${img.url}" alt="${img.alt || ''}">
            ${img.caption ? `<div class="slide-caption">${img.caption}</div>` : ''}
          </div>`;
      });

      // Initialize Swiper
      const swiper = new Swiper(".mySwiper", {
        pagination: { el: ".swiper-pagination", clickable: true },
        spaceBetween: 10,
      });

        // Add Google Map below markdown
        if (post.google_maps_embed_link) {
          const mapContainer = document.createElement('div');
          mapContainer.className = 'map-container';
          mapContainer.style = 'position:relative; padding-bottom:56.25%; height:0; overflow:hidden; margin-top:1rem;';
          mapContainer.innerHTML = `
            <iframe
              src="${post.google_maps_embed_link}"
              style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;"
              allowfullscreen
              loading="lazy">
            </iframe>
          `;
          document.getElementById('post-map').appendChild(mapContainer);
        }

      const related = publishedPosts
        .filter(p => p.slug !== currentSlug)
        .slice(0, 3);      
      const container = document.getElementById('related-posts');
      container.innerHTML = related.map(p => `
        <div class="col-md-12 col-lg-4 mb-4">
          <div class="post-preview-card shadow-sm bg-white rounded overflow-hidden h-100 d-flex flex-column">
            <img src="${p.image}" alt="${p.title}" class="post-img">
            <div class="post-content p-3 d-flex flex-column flex-grow-1">
              <a href="post.html?slug=${p.slug}" class="text-decoration-none text-dark flex-grow-1">
                <h2 class="post-title mb-1">${p.title}</h2>
                <h3 class="post-subtitle text-muted fs-6">${p.subtitle}</h3>
              </a>
              <p class="post-meta small text-muted mb-0">
                Posted on ${new Date(p.date).toLocaleDateString('en-US', { month:'long', day:'numeric', year:'numeric' })}
              </p>
            </div>
          </div>
        </div>
      `).join('');
  }

  initPost();

</script>

</body>
</html>