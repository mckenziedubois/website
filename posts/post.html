<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title id="page-title">Loading… | McKenzie DuBois</title>
  <link href="../css/styles.css" rel="stylesheet" />
  <link href="../css/custom.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css" />
  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5519492675847999"crossorigin="anonymous"></script>
</head>
<body>

  <!-- Navbar -->
  <div id="navbar-placeholder"></div>

  <!-- Masthead -->
  <header class="masthead">
    <div class="container position-relative px-4 px-lg-5">
      <div class="row gx-4 gx-lg-5 justify-content-center">
        <div class="col-md-10 col-lg-8 col-xl-7">
          <div class="post-heading text-center text-white">
            <h1 id="post-title">Loading…</h1>
            <h2 class="subheading" id="post-subtitle"></h2>
            <span class="meta" id="post-date"></span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="container px-4 px-lg-5 my-5">

    <div class="post-layout">
      <div class="post-left">
        <div id="markdown-content"></div>
      </div>

      <div class="post-right">
        <div class="return-button-container">
        <a href="../pages/bloghome.html" class="return-button">← Back to Guides</a>
        </div>
        <div id="airbnb-section-label" class="section-label"></div>
        <div id="airbnb-section" class="airbnb-listings"></div>
        <div class="mySwiper swiper">
          <div class="swiper-wrapper" id="gallery-wrapper"></div>
          <div class="swiper-pagination"></div>
        </div>
      </div>
    </div>

    <!-- MAP -->
    <div id="post-map"></div>

    <!-- Related posts -->
    <section class="related-posts mt-5">
      <h3 class="section-label">You May Also Like</h3>
      <div class="row gx-4 gx-lg-5" id="related-posts"></div>
    </section>

  </main>

  <!-- Footer -->
  <div id="footer-placeholder"></div> 

  <!-- Load partials -->
  <script src="../js/load-partials.js"></script>

  <!-- Swiper JS -->
  <script src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script>

  <!-- Markdown Parser -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Init Page -->
  <script>
    initPage({
      pageTitle: document.getElementById('post-title').textContent || 'Post',
      rootPrefix: '../',
      currentPage: 'post.html',
      loadMasthead: false 
    });
  </script>

  <!-- Post data fetch -->
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const currentSlug = urlParams.get('slug');

    async function loadCSV(url) {
      const text = await fetch(url).then(r => r.text());
      const [headerLine, ...lines] = text.trim().split("\n");
      const headers = headerLine.split(",");

      return lines.map(line => {
        const cols = line.split(",");
        return Object.fromEntries(headers.map((h, i) => [h.trim(), cols[i]?.trim()]));
      });
    }

    async function initPost() {
      const posts = await
      fetch('../posts/posts.json').
      then(res => res.json());

      const publishedPosts = posts.filter(p => p.active);
      const post = publishedPosts.find(p => p.slug === currentSlug);
      
      if (!post) return;

      const masthead = document.querySelector('.masthead');

      if (post.image && masthead) {
        masthead.style.backgroundImage = `url(${post.image})`;
        masthead.style.backgroundPosition = post.imagePosition || 'center';
        masthead.style.setProperty(
          '--masthead-overlay',
          post.overlay || '0.6'
        );
      }
                
      // Set post header info
      document.getElementById('post-title').textContent = post.title;
      document.getElementById('post-subtitle').textContent = post.subtitle;
      document.getElementById('post-date').textContent = new Date(post.date)
        .toLocaleDateString('en-US', { month:'long', day:'numeric', year:'numeric' });
      document.getElementById('page-title').textContent = `${post.title} | McKenzie DuBois`;

      // Load markdown content
      const mdRaw = await fetch(`../posts/content/${post.slug}.md`).then(res => res.text());
      document.getElementById('markdown-content').innerHTML = marked.parse(mdRaw);

      // Render Airbnb cards
      if (post.airbnbs?.length) {
        if (post.airbnbs.length === 1) {
          document.getElementById('airbnb-section-label').innerHTML = `<h3 class="section-label">Airbnb Recommendation</h3>`;
        } else {
          document.getElementById('airbnb-section-label').innerHTML = `<h3 class="section-label">Airbnb Recomendations</h3>`;
        }
        document.getElementById('airbnb-section').innerHTML = post.airbnbs.map(a => `
          <a class="airbnb-card" href="${a.url}" target="_blank">
            <div class="airbnb-image">
              <img src="${a.image}" alt="${a.title}">
            </div>
            <div class="airbnb-info">
              <h3>${a.title}</h3>
              <p>${a.info}</p>
            </div>
          </a>
        `).join('');
      }

      // Load gallery images
      const metadata = await loadCSV('../pages/image_metadata.csv');
      const galleryImages = metadata.filter(img => img.slug === currentSlug);

      // Build Swiper slides
      const wrapper = document.getElementById('gallery-wrapper');
      galleryImages.forEach(img => {
        wrapper.innerHTML += `
          <div class="swiper-slide">
            <div class="swiper-img-container">
              <img src="${img.url}" alt="${img.alt || ''}">
              ${img.caption ? `<div class="slide-caption">${img.caption}</div>` : ''}
          </div>`;
      });

      // Initialize Swiper
      const swiper = new Swiper(".mySwiper", {
        pagination: { el: ".swiper-pagination", clickable: true },
        spaceBetween: 10,
        keyboard: { enabled: true, onlyInViewport: true }
      });

        // Add Google Map below markdown
      if (post.google_maps_embed_link) {
        document.getElementById('post-map').innerHTML = `
          <div class="map-container">
            <iframe 
              src="${post.google_maps_embed_link}"
              allowfullscreen
              loading="lazy">
              </iframe>
          </div>
        `;
      }

    const currentTags = post.tags || [];

    const related = publishedPosts
      .filter(p => p.slug !== currentSlug)
      .map(p => {
        const sharedTags = (p.tags || []).filter(tag =>
          currentTags.includes(tag)
        );

        return {
          ...p,
          relevanceScore: sharedTags.length
        };
      })
      .sort((a, b) => {
        // Higher tag overlap first
        if (b.relevanceScore !== a.relevanceScore) {
          return b.relevanceScore - a.relevanceScore;
        }

        // Secondary sort: newest first
        return new Date(b.date) - new Date(a.date);
      })
      .slice(0, 3);

      const container = document.getElementById('related-posts');
      // Render related posts using the magazine-style card (same size as bloghome)
      container.innerHTML = related.map((p, index) => {
        // Hide 3rd related post on mobile (index 2)
        const hideOnMobile = index === 2 ? 'hide-on-mobile' : '';
        return `
        <div class="col-6 col-md-6 col-lg-4 mb-4 ${hideOnMobile}">
          <article class="card-magazine">
            <a class="card-media" href="post.html?slug=${p.slug}">
              <img src="${p.image}" alt="${p.title}" loading="lazy">
            </a>
            <div class="card-body">
              <a href="post.html?slug=${p.slug}" class="card-title">${p.title}</a>
              <p class="card-excerpt">${p.subtitle || ''}</p>
              <div class="card-meta">${new Date(p.date).toLocaleDateString('en-US', { month:'long', day:'numeric', year:'numeric' })}</div>
            </div>
          </article>
        </div>
        `;
      }).join('');
    }

    initPost();

  </script>

</body>
</html>